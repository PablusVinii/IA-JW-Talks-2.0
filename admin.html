<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body { background: var(--gradient-secondary, #f093fb); }
        .admin-container { max-width: 1200px; margin: 40px auto; background: rgba(255,255,255,0.98); border-radius: 18px; box-shadow: 0 4px 32px rgba(0,0,0,0.10); padding: 40px 24px; }
        .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; }
        .admin-header h1 { font-size: 2.2em; }
        .admin-nav { display: flex; gap: 18px; }
        .admin-nav button { background: var(--primary-color, #4a90e2); color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .admin-nav button:hover { background: var(--primary-dark, #357abd); }
        .admin-section { margin-bottom: 40px; }
        .admin-section h2 { font-size: 1.3em; margin-bottom: 16px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
        .admin-table th, .admin-table td { padding: 10px 8px; border-bottom: 1px solid #e9ecef; text-align: left; }
        .admin-table th { background: #f8fbff; }
        .admin-table tr:hover { background: #f1f7ff; }
        .admin-actions button { margin-right: 6px; }
        @media (max-width: 800px) {
            .admin-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .admin-container { padding: 18px 4px; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîí Painel Administrativo</h1>
            <div class="admin-nav">
                <button onclick="window.location.href='index.html'">üè† Voltar ao Sistema</button>
                <button onclick="logout()">üö™ Sair</button>
            </div>
        </div>
        <div class="admin-section" id="adminStats">
            <h2>üìä Estat√≠sticas Globais</h2>
            <div id="statsContent">Carregando estat√≠sticas...</div>
        </div>
        <div class="admin-section" id="adminUsers">
            <h2>üë• Usu√°rios</h2>
            <input type="text" id="buscaUsuario" placeholder="Buscar por nome, e-mail ou status..." style="width: 100%; max-width: 350px; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <div style="overflow-x:auto;">
                <table class="admin-table" id="tabelaUsuarios">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Data Cadastro</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Carregando usu√°rios...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="admin-section" id="adminEsbocos">
            <h2>üìö Esbo√ßos</h2>
            <input type="text" id="buscaEsboco" placeholder="Buscar por tema, usu√°rio, data..." style="width: 100%; max-width: 350px; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <div style="overflow-x:auto;">
                <table class="admin-table" id="tabelaEsbocos">
                    <thead>
                        <tr>
                            <th>Tema</th>
                            <th>Tipo</th>
                            <th>Usu√°rio</th>
                            <th>Data</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Carregando esbo√ßos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script>
    // Fun√ß√£o de logout global
    function logout() {
        firebase.auth().signOut().then(() => {
            window.location.href = 'login.html';
        });
    }

    // Restri√ß√£o de acesso: s√≥ admin
    document.body.style.display = 'none'; // Esconde at√© verificar
    const statsContent = document.getElementById('statsContent');
    statsContent.textContent = 'Verificando permiss√µes...';

    // Listagem de usu√°rios detalhada
    let todosUsuarios = [];
    const tabelaUsuarios = document.getElementById('tabelaUsuarios').getElementsByTagName('tbody')[0];
    const buscaUsuario = document.getElementById('buscaUsuario');

    function renderizarUsuarios(usuarios) {
        tabelaUsuarios.innerHTML = '';
        if (!usuarios.length) {
            tabelaUsuarios.innerHTML = '<tr><td colspan="5">Nenhum usu√°rio encontrado.</td></tr>';
            return;
        }
        usuarios.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.nome || '-'}</td>
                <td>${u.email || '-'}</td>
                <td>${u.criadoEm ? (u.criadoEm.toDate ? u.criadoEm.toDate().toLocaleString('pt-BR') : new Date(u.criadoEm).toLocaleString('pt-BR')) : '-'}</td>
                <td>${u.bloqueado ? '<span style="color:red;">Bloqueado</span>' : '<span style="color:green;">Ativo</span>'}</td>
                <td class="admin-actions">
                    <button onclick="bloquearUsuario('${u.uid}', ${!!u.bloqueado})" style="background:${u.bloqueado ? '#28a745' : '#dc3545'};color:#fff;">${u.bloqueado ? 'Desbloquear' : 'Bloquear'}</button>
                    <button onclick="redefinirSenhaUsuario('${u.email}')" style="background:#4a90e2;color:#fff;">Redefinir Senha</button>
                </td>
            `;
            tabelaUsuarios.appendChild(tr);
        });
    }

    function filtrarUsuarios() {
        const termo = (buscaUsuario.value || '').toLowerCase();
        if (!termo) {
            renderizarUsuarios(todosUsuarios);
            return;
        }
        const filtrados = todosUsuarios.filter(u => {
            return (u.nome || '').toLowerCase().includes(termo) ||
                   (u.email || '').toLowerCase().includes(termo) ||
                   (u.bloqueado ? 'bloqueado' : 'ativo').includes(termo);
        });
        renderizarUsuarios(filtrados);
    }
    buscaUsuario.addEventListener('input', filtrarUsuarios);

    // Carregar todos os usu√°rios do Firestore
    async function carregarUsuarios() {
        tabelaUsuarios.innerHTML = '<tr><td colspan="5">Carregando usu√°rios...</td></tr>';
        try {
            const snap = await firebase.firestore().collection('usuarios').orderBy('criadoEm', 'desc').get();
            todosUsuarios = snap.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            renderizarUsuarios(todosUsuarios);
        } catch (e) {
            tabelaUsuarios.innerHTML = '<tr><td colspan="5" style="color:red;">Erro ao carregar usu√°rios.</td></tr>';
        }
    }

    // Fun√ß√µes administrativas
    window.bloquearUsuario = async function(uid, bloqueadoAtual) {
        const confirmMsg = bloqueadoAtual ? 'Deseja DESBLOQUEAR este usu√°rio?' : 'Deseja BLOQUEAR este usu√°rio?';
        if (!confirm(confirmMsg)) return;
        try {
            await firebase.firestore().collection('usuarios').doc(uid).update({ bloqueado: !bloqueadoAtual });
            await carregarUsuarios();
            alert(bloqueadoAtual ? 'Usu√°rio desbloqueado!' : 'Usu√°rio bloqueado!');
        } catch (e) {
            alert('Erro ao atualizar status do usu√°rio.');
        }
    }
    window.redefinirSenhaUsuario = function(email) {
        if (!confirm('Enviar e-mail de redefini√ß√£o de senha para ' + email + '?')) return;
        firebase.auth().sendPasswordResetEmail(email)
            .then(() => alert('E-mail de redefini√ß√£o enviado!'))
            .catch(() => alert('Erro ao enviar e-mail de redefini√ß√£o.'));
    }

    // Listagem de esbo√ßos detalhada
    let todosEsbocos = [];
    const tabelaEsbocos = document.getElementById('tabelaEsbocos').getElementsByTagName('tbody')[0];
    const buscaEsboco = document.getElementById('buscaEsboco');

    // Mapeamento r√°pido de usu√°rios para exibir nome/email no esbo√ßo
    let mapaUsuarios = {};

    function renderizarEsbocos(esbocos) {
        tabelaEsbocos.innerHTML = '';
        if (!esbocos.length) {
            tabelaEsbocos.innerHTML = '<tr><td colspan="5">Nenhum esbo√ßo encontrado.</td></tr>';
            return;
        }
        esbocos.forEach(e => {
            const usuario = mapaUsuarios[e.uid] || { nome: '-', email: '-' };
            const usuarioStr = usuario.nome ? usuario.nome + ' (' + usuario.email + ')' : usuario.email || '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.tema || '-'}</td>
                <td>${e.tipoDiscurso || '-'}</td>
                <td>${usuarioStr}</td>
                <td>${e.criadoEm ? (e.criadoEm.toDate ? e.criadoEm.toDate().toLocaleString('pt-BR') : new Date(e.criadoEm).toLocaleString('pt-BR')) : '-'}</td>
                <td class="admin-actions">
                    <button onclick="visualizarEsbocoAdmin('${e.id}')" style="background:#4a90e2;color:#fff;">Visualizar</button>
                    <button onclick="excluirEsbocoAdmin('${e.id}')" style="background:#dc3545;color:#fff;">Excluir</button>
                </td>
            `;
            tabelaEsbocos.appendChild(tr);
        });
    }

    function filtrarEsbocos() {
        const termo = (buscaEsboco.value || '').toLowerCase();
        if (!termo) {
            renderizarEsbocos(todosEsbocos);
            return;
        }
        const filtrados = todosEsbocos.filter(e => {
            const usuario = mapaUsuarios[e.uid] || { nome: '', email: '' };
            return (e.tema || '').toLowerCase().includes(termo) ||
                   (e.tipoDiscurso || '').toLowerCase().includes(termo) ||
                   (usuario.nome || '').toLowerCase().includes(termo) ||
                   (usuario.email || '').toLowerCase().includes(termo) ||
                   (e.criadoEm && e.criadoEm.toDate && e.criadoEm.toDate().toLocaleString('pt-BR').includes(termo));
        });
        renderizarEsbocos(filtrados);
    }
    buscaEsboco.addEventListener('input', filtrarEsbocos);

    // Carregar todos os esbo√ßos do Firestore
    async function carregarEsbocos() {
        tabelaEsbocos.innerHTML = '<tr><td colspan="5">Carregando esbo√ßos...</td></tr>';
        try {
            // Carregar todos os usu√°rios para mapear nome/email
            const snapUsuarios = await firebase.firestore().collection('usuarios').get();
            mapaUsuarios = {};
            snapUsuarios.docs.forEach(doc => {
                mapaUsuarios[doc.id] = doc.data();
            });
            // Carregar todos os esbo√ßos
            const snap = await firebase.firestore().collection('esbocos').orderBy('criadoEm', 'desc').get();
            todosEsbocos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarEsbocos(todosEsbocos);
        } catch (e) {
            tabelaEsbocos.innerHTML = '<tr><td colspan="5" style="color:red;">Erro ao carregar esbo√ßos.</td></tr>';
        }
    }

    // Fun√ß√µes administrativas para esbo√ßos
    window.visualizarEsbocoAdmin = async function(id) {
        const doc = await firebase.firestore().collection('esbocos').doc(id).get();
        if (!doc.exists) return alert('Esbo√ßo n√£o encontrado.');
        const dados = doc.data();
        const usuario = mapaUsuarios[dados.uid] || { nome: '', email: '' };
        alert(
            `Tema: ${dados.tema}\nTipo: ${dados.tipoDiscurso}\nUsu√°rio: ${usuario.nome || usuario.email}\nData: ${dados.criadoEm && dados.criadoEm.toDate ? dados.criadoEm.toDate().toLocaleString('pt-BR') : '-'}\n\nConte√∫do:\n${dados.conteudo || ''}`
        );
    }
    window.excluirEsbocoAdmin = async function(id) {
        if (!confirm('Tem certeza que deseja excluir este esbo√ßo?')) return;
        try {
            await firebase.firestore().collection('esbocos').doc(id).delete();
            await carregarEsbocos();
            alert('Esbo√ßo exclu√≠do!');
        } catch (e) {
            alert('Erro ao excluir esbo√ßo.');
        }
    }

    // Estat√≠sticas globais
    async function carregarEstatisticasGlobais() {
        const statsDiv = document.getElementById('statsContent');
        statsDiv.innerHTML = 'Carregando estat√≠sticas...';
        try {
            // Usu√°rios
            const snapUsuarios = await firebase.firestore().collection('usuarios').orderBy('criadoEm', 'desc').get();
            const usuarios = snapUsuarios.docs.map(doc => doc.data());
            const totalUsuarios = usuarios.length;
            const totalAdmins = usuarios.filter(u => u.admin).length;
            const totalBloqueados = usuarios.filter(u => u.bloqueado).length;
            // Novos usu√°rios no m√™s
            const agora = new Date();
            const mesAtual = agora.getMonth();
            const anoAtual = agora.getFullYear();
            const novosNoMes = usuarios.filter(u => {
                if (!u.criadoEm) return false;
                const d = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
                return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
            }).length;
            // √öltimo usu√°rio cadastrado
            const ultimoUsuario = usuarios[0];
            // Esbo√ßos
            const snapEsbocos = await firebase.firestore().collection('esbocos').orderBy('criadoEm', 'desc').get();
            const esbocos = snapEsbocos.docs.map(doc => doc.data());
            const totalEsbocos = esbocos.length;
            const esbocosNoMes = esbocos.filter(e => {
                if (!e.criadoEm) return false;
                const d = e.criadoEm.toDate ? e.criadoEm.toDate() : new Date(e.criadoEm);
                return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
            }).length;
            // √öltimo esbo√ßo
            const ultimoEsboco = esbocos[0];
            // Exibir
            statsDiv.innerHTML = `
                <div style="display:flex;flex-wrap:wrap;gap:24px;">
                    <div style="flex:1;min-width:220px;background:#f8fbff;padding:18px 14px;border-radius:10px;">
                        <strong>Total de usu√°rios:</strong> <span style="font-size:1.2em;">${totalUsuarios}</span><br>
                        <strong>Novos este m√™s:</strong> ${novosNoMes}<br>
                        <strong>Bloqueados:</strong> ${totalBloqueados}<br>
                        <strong>Admins:</strong> ${totalAdmins}<br>
                        <strong>√öltimo cadastrado:</strong> ${ultimoUsuario ? (ultimoUsuario.nome || '-') + ' (' + (ultimoUsuario.email || '-') + ')' : '-'}
                    </div>
                    <div style="flex:1;min-width:220px;background:#f8fbff;padding:18px 14px;border-radius:10px;">
                        <strong>Total de esbo√ßos:</strong> <span style="font-size:1.2em;">${totalEsbocos}</span><br>
                        <strong>Este m√™s:</strong> ${esbocosNoMes}<br>
                        <strong>√öltimo esbo√ßo:</strong> ${ultimoEsboco ? (ultimoEsboco.tema || '-') + ' (' + (ultimoEsboco.criadoEm && ultimoEsboco.criadoEm.toDate ? ultimoEsboco.criadoEm.toDate().toLocaleString('pt-BR') : '-') + ')' : '-'}
                    </div>
                </div>
            `;
        } catch (e) {
            statsDiv.innerHTML = '<span style="color:red;">Erro ao carregar estat√≠sticas.</span>';
        }
    }

    // Ap√≥s autentica√ß√£o e permiss√£o, carregar estat√≠sticas tamb√©m
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        try {
            const doc = await firebase.firestore().collection('usuarios').doc(user.uid).get();
            if (!doc.exists || !doc.data().admin) {
                alert('Acesso restrito: apenas administradores podem acessar este painel.');
                window.location.href = 'index.html';
                return;
            }
            document.body.style.display = '';
            statsContent.textContent = 'Carregando estat√≠sticas...';
            await carregarEstatisticasGlobais();
            await carregarUsuarios();
            await carregarEsbocos();
        } catch (e) {
            alert('Erro ao verificar permiss√µes.');
            window.location.href = 'index.html';
        }
    });
    // Placeholders: as pr√≥ximas etapas v√£o implementar carregamento e a√ß√µes.
    </script>
</body>
</html> 