<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
        body { background: var(--gradient-secondary, #f093fb); }
        .admin-container { max-width: 1200px; margin: 40px auto; background: rgba(255,255,255,0.98); border-radius: 18px; box-shadow: 0 4px 32px rgba(0,0,0,0.10); padding: 40px 24px; }
        .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; }
        .admin-header h1 { font-size: 2.2em; }
        .admin-nav { display: flex; gap: 18px; }
        .admin-nav button { background: var(--primary-color, #4a90e2); color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .admin-nav button:hover { background: var(--primary-dark, #357abd); }
        .admin-section { margin-bottom: 40px; }
        .admin-section h2 { font-size: 1.3em; margin-bottom: 16px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
        .admin-table th, .admin-table td { padding: 10px 8px; border-bottom: 1px solid #e9ecef; text-align: left; }
        .admin-table th { background: #f8fbff; }
        .admin-table tr:hover { background: #f1f7ff; }
        .admin-actions button { margin-right: 6px; }
        .btn-export { background: #28a745; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .btn-export:hover { background: #218838; }
        @media (max-width: 800px) {
            .admin-header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .admin-container { padding: 18px 4px; }
            #dashboardCharts { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>ğŸ”’ Painel Administrativo</h1>
            <div class="admin-nav">
                <button onclick="window.location.href='index.html'">ğŸ  Voltar ao Sistema</button>
                <button onclick="logout()">ğŸšª Sair</button>
            </div>
        </div>
        <div class="admin-section" id="adminStats">
            <h2>ğŸ“Š EstatÃ­sticas Globais</h2>
            <div id="statsContent">Carregando estatÃ­sticas...</div>
        </div>
        
        <div class="admin-section" id="adminDashboard">
            <h2>ğŸ“ˆ Dashboard com GrÃ¡ficos</h2>
            <div style="display:flex;gap:20px;margin-bottom:20px;">
                <button onclick="exportarDados('usuarios')" class="btn-export">ğŸ“Š Exportar UsuÃ¡rios (CSV)</button>
                <button onclick="exportarDados('esbocos')" class="btn-export">ğŸ“Š Exportar EsboÃ§os (CSV)</button>
                <button onclick="exportarDados('logs')" class="btn-export">ğŸ“Š Exportar Logs (CSV)</button>
                <button onclick="gerarRelatorio()" class="btn-export">ğŸ“‹ Gerar RelatÃ³rio Completo</button>
            </div>
            <div id="dashboardCharts">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                    <div style="background:#f8fbff;padding:20px;border-radius:10px;">
                        <h3>ğŸ‘¥ UsuÃ¡rios por MÃªs</h3>
                        <canvas id="chartUsuarios" width="400" height="200"></canvas>
                    </div>
                    <div style="background:#f8fbff;padding:20px;border-radius:10px;">
                        <h3>ğŸ“š EsboÃ§os por MÃªs</h3>
                        <canvas id="chartEsbocos" width="400" height="200"></canvas>
                    </div>
                </div>
                <div style="background:#f8fbff;padding:20px;border-radius:10px;">
                    <h3>ğŸ“Š Atividade por Tipo</h3>
                    <canvas id="chartAtividade" width="800" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="admin-section" id="adminUsers">
            <h2>ğŸ‘¥ UsuÃ¡rios</h2>
            <input type="text" id="buscaUsuario" placeholder="Buscar por nome, e-mail ou status..." style="width: 100%; max-width: 350px; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <div style="background:#f8fbff;padding:15px;border-radius:8px;max-height:300px;overflow-y:auto;">
                <table class="admin-table" id="tabelaUsuarios">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>E-mail</th>
                            <th>Data Cadastro</th>
                            <th>Status</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Carregando usuÃ¡rios...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="admin-section" id="adminEsbocos">
            <h2>ğŸ“š EsboÃ§os</h2>
            <input type="text" id="buscaEsboco" placeholder="Buscar por tema, usuÃ¡rio, data..." style="width: 100%; max-width: 350px; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <div style="background:#f8fbff;padding:15px;border-radius:8px;max-height:300px;overflow-y:auto;">
                <table class="admin-table" id="tabelaEsbocos">
                    <thead>
                        <tr>
                            <th>Tema</th>
                            <th>Tipo</th>
                            <th>UsuÃ¡rio</th>
                            <th>Data</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Carregando esboÃ§os...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="admin-section" id="adminLogs">
            <h2>ğŸ“ Logs de Auditoria</h2>
            <input type="text" id="buscaLog" placeholder="Buscar por aÃ§Ã£o, usuÃ¡rio, e-mail ou data..." style="width: 100%; max-width: 350px; margin-bottom: 12px; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
            <div style="background:#f8fbff;padding:15px;border-radius:8px;max-height:300px;overflow-y:auto;">
                <table class="admin-table" id="tabelaLogs">
                    <thead>
                        <tr>
                            <th>UsuÃ¡rio (UID)</th>
                            <th>E-mail</th>
                            <th>AÃ§Ã£o</th>
                            <th>Detalhes</th>
                            <th>Data/Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5">Carregando logs...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="admin-section" id="adminNotificacoes">
            <h2>ğŸ”” NotificaÃ§Ãµes do Sistema</h2>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button onclick="enviarNotificacaoGeral()" class="btn-export">ğŸ“¢ Enviar NotificaÃ§Ã£o Geral</button>
                <button onclick="enviarNotificacaoUsuarios()" class="btn-export">ğŸ‘¥ Notificar UsuÃ¡rios EspecÃ­ficos</button>
                <button onclick="configurarNotificacoes()" class="btn-export">âš™ï¸ Configurar Alertas</button>
            </div>
            <div id="notificacoesList" style="background:#f8fbff;padding:15px;border-radius:8px;max-height:300px;overflow-y:auto;">
                <h4>ğŸ“‹ HistÃ³rico de NotificaÃ§Ãµes</h4>
                <div id="historicoNotificacoes">Carregando notificaÃ§Ãµes...</div>
            </div>
        </div>
        
        <div class="admin-section" id="adminBackup">
            <h2>ğŸ’¾ Backup e ManutenÃ§Ã£o</h2>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button onclick="criarBackupCompleto()" class="btn-export">ğŸ’¾ Criar Backup Completo</button>
                <button onclick="limparDadosAntigos()" class="btn-export">ğŸ—‘ï¸ Limpar Dados Antigos</button>
                <button onclick="configurarBackupAutomatico()" class="btn-export">â° Configurar Backup AutomÃ¡tico</button>
                <button onclick="verificarIntegridade()" class="btn-export">ğŸ” Verificar Integridade</button>
            </div>
            <div id="backupStatus" style="background:#f8fbff;padding:15px;border-radius:8px;">
                <h4>ğŸ“Š Status do Sistema</h4>
                <div id="statusSistema">Carregando status...</div>
            </div>
        </div>
        
        <div class="admin-section" id="adminIntegracoes">
            <h2>ğŸ”— IntegraÃ§Ãµes AvanÃ§adas</h2>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button onclick="configurarEmailReal()" class="btn-export">ğŸ“§ Configurar E-mail Real</button>
                <button onclick="ativarNotificacoesPush()" class="btn-export">ğŸ”” Ativar NotificaÃ§Ãµes Push</button>
                <button onclick="configurarWebhooks()" class="btn-export">ğŸ”— Configurar Webhooks</button>
                <button onclick="testarIntegracoes()" class="btn-export">ğŸ§ª Testar IntegraÃ§Ãµes</button>
            </div>
            <div id="integracoesStatus" style="background:#f8fbff;padding:15px;border-radius:8px;">
                <h4>ğŸ“Š Status das IntegraÃ§Ãµes</h4>
                <div id="statusIntegracoes">Carregando status das integraÃ§Ãµes...</div>
            </div>
        </div>
        
        <div class="admin-section" id="adminAnalytics">
            <h2>ğŸ“ˆ Analytics AvanÃ§ado</h2>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button onclick="gerarRelatorioDetalhado()" class="btn-export">ğŸ“Š RelatÃ³rio Detalhado</button>
                <button onclick="analisarComportamento()" class="btn-export">ğŸ§  AnÃ¡lise de Comportamento</button>
                <button onclick="previsoesSistema()" class="btn-export">ğŸ”® PrevisÃµes</button>
                <button onclick="exportarAnalytics()" class="btn-export">ğŸ“¤ Exportar Analytics</button>
            </div>
            <div id="analyticsContent" style="background:#f8fbff;padding:15px;border-radius:8px;">
                <h4>ğŸ“ˆ MÃ©tricas AvanÃ§adas</h4>
                <div id="metricasAvancadas">Carregando mÃ©tricas...</div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script>
    // FunÃ§Ã£o de logout global
    function logout() {
        firebase.auth().signOut().then(() => {
            window.location.href = 'login.html';
        });
    }

    // FunÃ§Ã£o global para testar logs
    window.testarLogs = testarAcessoLogs;

    // FunÃ§Ãµes de exportaÃ§Ã£o de dados
    function exportarDados(tipo) {
        let dados = [];
        let nomeArquivo = '';
        
        switch(tipo) {
            case 'usuarios':
                dados = todosUsuarios.map(u => ({
                    Nome: u.nome || '',
                    Email: u.email || '',
                    Data_Cadastro: u.criadoEm ? (u.criadoEm.toDate ? u.criadoEm.toDate().toLocaleString('pt-BR') : new Date(u.criadoEm).toLocaleString('pt-BR')) : '',
                    Admin: u.admin ? 'Sim' : 'NÃ£o',
                    Bloqueado: u.bloqueado ? 'Sim' : 'NÃ£o'
                }));
                nomeArquivo = 'usuarios.csv';
                break;
            case 'esbocos':
                dados = todosEsbocos.map(e => ({
                    Tema: e.tema || '',
                    Tipo: e.tipoDiscurso || '',
                    Usuario: mapaUsuarios[e.uid] ? (mapaUsuarios[e.uid].nome || mapaUsuarios[e.uid].email) : '',
                    Data_Criacao: e.criadoEm ? (e.criadoEm.toDate ? e.criadoEm.toDate().toLocaleString('pt-BR') : new Date(e.criadoEm).toLocaleString('pt-BR')) : '',
                    Favorito: e.favorito ? 'Sim' : 'NÃ£o'
                }));
                nomeArquivo = 'esbocos.csv';
                break;
            case 'logs':
                dados = todosLogs.map(l => ({
                    UID: l.uid || '',
                    Email: l.email || '',
                    Acao: l.acao || '',
                    Detalhes: l.detalhes ? JSON.stringify(l.detalhes) : '',
                    Data: l.data && l.data.toDate ? l.data.toDate().toLocaleString('pt-BR') : (l.data ? new Date(l.data).toLocaleString('pt-BR') : '')
                }));
                nomeArquivo = 'logs.csv';
                break;
        }
        
        if (dados.length === 0) {
            alert('Nenhum dado disponÃ­vel para exportar.');
            return;
        }
        
        const csv = converterParaCSV(dados);
        downloadCSV(csv, nomeArquivo);
    }

    function converterParaCSV(dados) {
        if (dados.length === 0) return '';
        
        const headers = Object.keys(dados[0]);
        const csvContent = [
            headers.join(','),
            ...dados.map(row => headers.map(header => {
                const value = row[header] || '';
                return `"${value.toString().replace(/"/g, '""')}"`;
            }).join(','))
        ].join('\n');
        
        return csvContent;
    }

    function downloadCSV(csv, nomeArquivo) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', nomeArquivo);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function gerarRelatorio() {
        const agora = new Date();
        const relatorio = {
            titulo: 'RelatÃ³rio Completo - IA-JW-Talks',
            data: agora.toLocaleString('pt-BR'),
            estatisticas: {
                totalUsuarios: todosUsuarios.length,
                totalEsbocos: todosEsbocos.length,
                totalLogs: todosLogs.length,
                admins: todosUsuarios.filter(u => u.admin).length,
                bloqueados: todosUsuarios.filter(u => u.bloqueado).length
            },
            usuarios: todosUsuarios.map(u => ({
                nome: u.nome || '',
                email: u.email || '',
                admin: u.admin ? 'Sim' : 'NÃ£o',
                bloqueado: u.bloqueado ? 'Sim' : 'NÃ£o'
            })),
            esbocos: todosEsbocos.map(e => ({
                tema: e.tema || '',
                tipo: e.tipoDiscurso || '',
                usuario: mapaUsuarios[e.uid] ? (mapaUsuarios[e.uid].nome || mapaUsuarios[e.uid].email) : ''
            }))
        };
        
        const json = JSON.stringify(relatorio, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `relatorio_${agora.getFullYear()}_${(agora.getMonth()+1).toString().padStart(2,'0')}_${agora.getDate().toString().padStart(2,'0')}.json`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // FunÃ§Ãµes para gerar grÃ¡ficos
    function gerarGraficos() {
        gerarGraficoUsuarios();
        gerarGraficoEsbocos();
        gerarGraficoAtividade();
    }

    function gerarGraficoUsuarios() {
        const canvas = document.getElementById('chartUsuarios');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const dados = processarDadosUsuariosPorMes();
        
        // GrÃ¡fico simples usando canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#4a90e2';
        
        const maxValue = Math.max(...dados.values);
        const barWidth = canvas.width / dados.labels.length - 10;
        const maxBarHeight = canvas.height - 40;
        
        dados.labels.forEach((label, index) => {
            const barHeight = (dados.values[index] / maxValue) * maxBarHeight;
            const x = index * (barWidth + 10) + 5;
            const y = canvas.height - barHeight - 20;
            
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Texto
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText(dados.values[index], x + barWidth/2 - 10, y - 5);
            ctx.fillText(label, x + barWidth/2 - 15, canvas.height - 5);
            ctx.fillStyle = '#4a90e2';
        });
    }

    function gerarGraficoEsbocos() {
        const canvas = document.getElementById('chartEsbocos');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const dados = processarDadosEsbocosPorMes();
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#28a745';
        
        const maxValue = Math.max(...dados.values);
        const barWidth = canvas.width / dados.labels.length - 10;
        const maxBarHeight = canvas.height - 40;
        
        dados.labels.forEach((label, index) => {
            const barHeight = (dados.values[index] / maxValue) * maxBarHeight;
            const x = index * (barWidth + 10) + 5;
            const y = canvas.height - barHeight - 20;
            
            ctx.fillRect(x, y, barWidth, barHeight);
            
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText(dados.values[index], x + barWidth/2 - 10, y - 5);
            ctx.fillText(label, x + barWidth/2 - 15, canvas.height - 5);
            ctx.fillStyle = '#28a745';
        });
    }

    function gerarGraficoAtividade() {
        const canvas = document.getElementById('chartAtividade');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const dados = processarDadosAtividade();
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const cores = ['#4a90e2', '#28a745', '#ffc107', '#dc3545', '#6f42c1'];
        const total = dados.values.reduce((a, b) => a + b, 0);
        let anguloAtual = 0;
        
        dados.labels.forEach((label, index) => {
            const slice = (dados.values[index] / total) * 2 * Math.PI;
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            const raio = Math.min(x, y) - 50;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.arc(x, y, raio, anguloAtual, anguloAtual + slice);
            ctx.closePath();
            ctx.fillStyle = cores[index % cores.length];
            ctx.fill();
            
            // Texto
            const textoAngulo = anguloAtual + slice / 2;
            const textoX = x + Math.cos(textoAngulo) * (raio / 2);
            const textoY = y + Math.sin(textoAngulo) * (raio / 2);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${label}: ${dados.values[index]}`, textoX, textoY);
            
            anguloAtual += slice;
        });
    }

    function processarDadosUsuariosPorMes() {
        const meses = {};
        const agora = new Date();
        
        // Ãšltimos 6 meses
        for (let i = 5; i >= 0; i--) {
            const mes = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
            const chave = mes.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            meses[chave] = 0;
        }
        
        todosUsuarios.forEach(u => {
            if (u.criadoEm) {
                const data = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
                const chave = data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                if (meses[chave] !== undefined) {
                    meses[chave]++;
                }
            }
        });
        
        return {
            labels: Object.keys(meses),
            values: Object.values(meses)
        };
    }

    function processarDadosEsbocosPorMes() {
        const meses = {};
        const agora = new Date();
        
        for (let i = 5; i >= 0; i--) {
            const mes = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
            const chave = mes.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            meses[chave] = 0;
        }
        
        todosEsbocos.forEach(e => {
            if (e.criadoEm) {
                const data = e.criadoEm.toDate ? e.criadoEm.toDate() : new Date(e.criadoEm);
                const chave = data.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                if (meses[chave] !== undefined) {
                    meses[chave]++;
                }
            }
        });
        
        return {
            labels: Object.keys(meses),
            values: Object.values(meses)
        };
    }

    function processarDadosAtividade() {
        const atividades = {};
        
        todosLogs.forEach(log => {
            const acao = log.acao || 'outro';
            atividades[acao] = (atividades[acao] || 0) + 1;
        });
        
        return {
            labels: Object.keys(atividades),
            values: Object.values(atividades)
        };
    }

    // Sistema de NotificaÃ§Ãµes
    function enviarNotificacaoGeral() {
        const mensagem = prompt('Digite a mensagem para enviar a todos os usuÃ¡rios:');
        if (!mensagem) return;
        
        const titulo = prompt('Digite o tÃ­tulo da notificaÃ§Ã£o (opcional):') || 'NotificaÃ§Ã£o do Sistema';
        
        if (confirm(`Enviar notificaÃ§Ã£o para TODOS os usuÃ¡rios?\n\nTÃ­tulo: ${titulo}\nMensagem: ${mensagem}`)) {
            enviarNotificacao(mensagem, titulo, 'geral');
        }
    }

    function enviarNotificacaoUsuarios() {
        const usuariosAtivos = todosUsuarios.filter(u => !u.bloqueado);
        if (usuariosAtivos.length === 0) {
            alert('Nenhum usuÃ¡rio ativo encontrado.');
            return;
        }
        
        const mensagem = prompt('Digite a mensagem para enviar aos usuÃ¡rios ativos:');
        if (!mensagem) return;
        
        const titulo = prompt('Digite o tÃ­tulo da notificaÃ§Ã£o (opcional):') || 'NotificaÃ§Ã£o do Sistema';
        
        if (confirm(`Enviar notificaÃ§Ã£o para ${usuariosAtivos.length} usuÃ¡rios ativos?\n\nTÃ­tulo: ${titulo}\nMensagem: ${mensagem}`)) {
            enviarNotificacao(mensagem, titulo, 'usuarios_ativos', usuariosAtivos.map(u => u.uid));
        }
    }

    function configurarNotificacoes() {
        const config = {
            alertaNovosUsuarios: confirm('Receber alerta quando novos usuÃ¡rios se cadastrarem?'),
            alertaNovosEsbocos: confirm('Receber alerta quando novos esboÃ§os forem criados?'),
            alertaUsuariosBloqueados: confirm('Receber alerta quando usuÃ¡rios forem bloqueados?'),
            alertaErrosSistema: confirm('Receber alerta quando houver erros no sistema?')
        };
        
        localStorage.setItem('adminNotificacoes', JSON.stringify(config));
        alert('ConfiguraÃ§Ãµes de notificaÃ§Ãµes salvas!');
    }

    async function enviarNotificacao(mensagem, titulo, tipo, usuariosEspecificos = null) {
        try {
            // Determinar destinatÃ¡rios
            let destinatarios = [];
            let isNotificacaoGeral = false;
            
            if (usuariosEspecificos && usuariosEspecificos.length > 0) {
                // UsuÃ¡rios especÃ­ficos
                destinatarios = usuariosEspecificos;
                isNotificacaoGeral = false;
            } else {
                // Todos os usuÃ¡rios ativos
                destinatarios = todosUsuarios
                    .filter(u => !u.bloqueado)
                    .map(u => u.uid);
                isNotificacaoGeral = true;
            }
            
            // Criar notificaÃ§Ã£o para cada destinatÃ¡rio
            const batch = firebase.firestore().batch();
            
            if (isNotificacaoGeral) {
                // Para notificaÃ§Ã£o geral, criar uma Ãºnica notificaÃ§Ã£o que serÃ¡ visÃ­vel para todos
                const notificacaoRef = firebase.firestore().collection('notificacoes').doc();
                const notificacao = {
                    titulo,
                    mensagem,
                    tipo: tipo || 'info',
                    destinatarios: ["todos"], // Marca como notificaÃ§Ã£o geral
                    geral: true, // Campo adicional para identificar notificaÃ§Ãµes gerais
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    admin: firebase.auth().currentUser.email,
                    lida: false,
                    lidaEm: null,
                    totalDestinatarios: destinatarios.length // Para referÃªncia
                };
                
                batch.set(notificacaoRef, notificacao);
            } else {
                // Para usuÃ¡rios especÃ­ficos, criar notificaÃ§Ã£o individual para cada um
                destinatarios.forEach(uid => {
                    const notificacaoRef = firebase.firestore().collection('notificacoes').doc();
                    const notificacao = {
                        titulo,
                        mensagem,
                        tipo: tipo || 'info',
                        destinatarios: [uid], // Array com o UID do destinatÃ¡rio
                        geral: false, // NotificaÃ§Ã£o especÃ­fica
                        data: firebase.firestore.FieldValue.serverTimestamp(),
                        admin: firebase.auth().currentUser.email,
                        lida: false,
                        lidaEm: null
                    };
                    
                    batch.set(notificacaoRef, notificacao);
                });
            }
            
            await batch.commit();
            
            // Registrar log
            await registrarLogAcao('enviar_notificacao', {
                tipo,
                titulo,
                mensagem: mensagem.substring(0, 50) + (mensagem.length > 50 ? '...' : ''),
                destinatarios: destinatarios.length,
                geral: isNotificacaoGeral
            });
            
            alert(`NotificaÃ§Ã£o enviada com sucesso para ${destinatarios.length} usuÃ¡rio(s)!`);
            carregarHistoricoNotificacoes();
        } catch (error) {
            console.error('Erro ao enviar notificaÃ§Ã£o:', error);
            alert('Erro ao enviar notificaÃ§Ã£o: ' + error.message);
        }
    }

    async function carregarHistoricoNotificacoes() {
        const historicoDiv = document.getElementById('historicoNotificacoes');
        try {
            const snap = await firebase.firestore().collection('notificacoes')
                .orderBy('data', 'desc')
                .limit(10)
                .get();
            
            if (snap.empty) {
                historicoDiv.innerHTML = '<p>Nenhuma notificaÃ§Ã£o encontrada.</p>';
                return;
            }
            
            const notificacoes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            historicoDiv.innerHTML = notificacoes.map(n => {
                const tipoNotificacao = n.geral ? 
                    `<span style="background:#ff6b6b;color:white;padding:2px 6px;border-radius:10px;font-size:10px;">GERAL</span>` : 
                    `<span style="background:#4a90e2;color:white;padding:2px 6px;border-radius:10px;font-size:10px;">ESPECÃFICA</span>`;
                
                const destinatariosInfo = n.geral ? 
                    `Para todos os usuÃ¡rios (${n.totalDestinatarios || 'N/A'})` : 
                    `Para ${n.destinatarios ? n.destinatarios.length : 0} usuÃ¡rio(s)`;
                
                return `
                    <div style="border-bottom:1px solid #ddd;padding:10px 0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                            <strong>${n.titulo}</strong>
                            ${tipoNotificacao}
                        </div>
                        <small>${n.mensagem}</small><br>
                        <small style="color:#666;">
                            Tipo: ${n.tipo || 'info'} | 
                            ${destinatariosInfo} | 
                            Lida: ${n.lida ? 'Sim' : 'NÃ£o'} | 
                            Admin: ${n.admin} | 
                            Data: ${n.data && n.data.toDate ? n.data.toDate().toLocaleString('pt-BR') : '-'}
                        </small>
                    </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Erro ao carregar histÃ³rico de notificaÃ§Ãµes:', error);
            historicoDiv.innerHTML = '<p style="color:red;">Erro ao carregar notificaÃ§Ãµes.</p>';
        }
    }

    // FunÃ§Ã£o para registrar logs (reutilizada do script.js)
    async function registrarLogAcao(acao, detalhes = {}) {
        try {
            const user = firebase.auth().currentUser;
            await firebase.firestore().collection('logs').add({
                uid: user ? user.uid : null,
                email: user ? user.email : null,
                acao,
                detalhes,
                data: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) {
            console.error('Erro ao registrar log:', e);
        }
    }

    // Sistema de Backup e ManutenÃ§Ã£o
    async function criarBackupCompleto() {
        if (!confirm('Criar backup completo de todos os dados? Isso pode demorar alguns minutos.')) return;
        
        try {
            const statusDiv = document.getElementById('statusSistema');
            statusDiv.innerHTML = 'ğŸ”„ Criando backup...';
            
            const backup = {
                data: new Date().toISOString(),
                admin: firebase.auth().currentUser.email,
                usuarios: todosUsuarios,
                esbocos: todosEsbocos,
                logs: todosLogs.slice(0, 1000), // Limitar logs para nÃ£o sobrecarregar
                estatisticas: {
                    totalUsuarios: todosUsuarios.length,
                    totalEsbocos: todosEsbocos.length,
                    totalLogs: todosLogs.length
                }
            };
            
            // Salvar backup no Firestore
            await firebase.firestore().collection('backups').add({
                ...backup,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Registrar log
            await registrarLogAcao('criar_backup', {
                totalUsuarios: backup.estatisticas.totalUsuarios,
                totalEsbocos: backup.estatisticas.totalEsbocos,
                totalLogs: backup.estatisticas.totalLogs
            });
            
            // Download do backup como JSON
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            statusDiv.innerHTML = 'âœ… Backup criado com sucesso! Arquivo baixado automaticamente.';
            setTimeout(() => carregarStatusSistema(), 3000);
            
        } catch (error) {
            console.error('Erro ao criar backup:', error);
            document.getElementById('statusSistema').innerHTML = 'âŒ Erro ao criar backup: ' + error.message;
        }
    }

    async function limparDadosAntigos() {
        const dias = prompt('Remover logs mais antigos que quantos dias? (padrÃ£o: 30)', '30');
        if (!dias || isNaN(dias)) return;
        
        if (!confirm(`Remover logs mais antigos que ${dias} dias? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;
        
        try {
            const statusDiv = document.getElementById('statusSistema');
            statusDiv.innerHTML = 'ğŸ”„ Limpando dados antigos...';
            
            const dataLimite = new Date();
            dataLimite.setDate(dataLimite.getDate() - parseInt(dias));
            
            // Buscar logs antigos
            const snap = await firebase.firestore().collection('logs')
                .where('data', '<', dataLimite)
                .get();
            
            if (snap.empty) {
                statusDiv.innerHTML = 'â„¹ï¸ Nenhum log antigo encontrado.';
                return;
            }
            
            // Deletar logs em lotes
            const batch = firebase.firestore().batch();
            snap.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            
            await registrarLogAcao('limpar_dados_antigos', {
                dias,
                logsRemovidos: snap.size
            });
            
            statusDiv.innerHTML = `âœ… ${snap.size} logs antigos removidos com sucesso!`;
            setTimeout(() => carregarStatusSistema(), 3000);
            
        } catch (error) {
            console.error('Erro ao limpar dados:', error);
            document.getElementById('statusSistema').innerHTML = 'âŒ Erro ao limpar dados: ' + error.message;
        }
    }

    function configurarBackupAutomatico() {
        const config = {
            backupDiario: confirm('Ativar backup automÃ¡tico diÃ¡rio?'),
            backupSemanal: confirm('Ativar backup automÃ¡tico semanal?'),
            manterBackups: prompt('Manter quantos backups? (padrÃ£o: 7)', '7') || '7',
            limparLogsAutomatico: confirm('Limpar logs automaticamente apÃ³s 30 dias?')
        };
        
        localStorage.setItem('adminBackupConfig', JSON.stringify(config));
        alert('ConfiguraÃ§Ãµes de backup salvas!');
        
        // Simular backup automÃ¡tico (em produÃ§Ã£o seria um cron job)
        if (config.backupDiario || config.backupSemanal) {
            alert('Backup automÃ¡tico configurado! Em produÃ§Ã£o, isso seria executado por um servidor.');
        }
    }

    async function verificarIntegridade() {
        try {
            const statusDiv = document.getElementById('statusSistema');
            statusDiv.innerHTML = 'ğŸ” Verificando integridade...';
            
            const problemas = [];
            
            // Verificar usuÃ¡rios sem nome
            const usuariosSemNome = todosUsuarios.filter(u => !u.nome);
            if (usuariosSemNome.length > 0) {
                problemas.push(`${usuariosSemNome.length} usuÃ¡rios sem nome`);
            }
            
            // Verificar esboÃ§os sem tema
            const esbocosSemTema = todosEsbocos.filter(e => !e.tema);
            if (esbocosSemTema.length > 0) {
                problemas.push(`${esbocosSemTema.length} esboÃ§os sem tema`);
            }
            
            // Verificar logs sem aÃ§Ã£o
            const logsSemAcao = todosLogs.filter(l => !l.acao);
            if (logsSemAcao.length > 0) {
                problemas.push(`${logsSemAcao.length} logs sem aÃ§Ã£o`);
            }
            
            // Verificar usuÃ¡rios Ã³rfÃ£os (esboÃ§os de usuÃ¡rios que nÃ£o existem)
            const uidsUsuarios = new Set(todosUsuarios.map(u => u.uid));
            const esbocosOrfaos = todosEsbocos.filter(e => !uidsUsuarios.has(e.uid));
            if (esbocosOrfaos.length > 0) {
                problemas.push(`${esbocosOrfaos.length} esboÃ§os de usuÃ¡rios inexistentes`);
            }
            
            if (problemas.length === 0) {
                statusDiv.innerHTML = 'âœ… Sistema Ã­ntegro! Nenhum problema encontrado.';
            } else {
                statusDiv.innerHTML = `âš ï¸ Encontrados ${problemas.length} problemas:<br>` + 
                    problemas.map(p => `â€¢ ${p}`).join('<br>');
            }
            
        } catch (error) {
            console.error('Erro ao verificar integridade:', error);
            document.getElementById('statusSistema').innerHTML = 'âŒ Erro ao verificar integridade: ' + error.message;
        }
    }

    async function carregarStatusSistema() {
        const statusDiv = document.getElementById('statusSistema');
        try {
            const agora = new Date();
            const ultimoBackup = localStorage.getItem('ultimoBackup') || 'Nunca';
            const configBackup = JSON.parse(localStorage.getItem('adminBackupConfig') || '{}');
            
            statusDiv.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <strong>ğŸ“Š EstatÃ­sticas:</strong><br>
                        â€¢ UsuÃ¡rios: ${todosUsuarios.length}<br>
                        â€¢ EsboÃ§os: ${todosEsbocos.length}<br>
                        â€¢ Logs: ${todosLogs.length}<br>
                        â€¢ Ãšltimo backup: ${ultimoBackup}
                    </div>
                    <div>
                        <strong>âš™ï¸ ConfiguraÃ§Ãµes:</strong><br>
                        â€¢ Backup diÃ¡rio: ${configBackup.backupDiario ? 'âœ…' : 'âŒ'}<br>
                        â€¢ Backup semanal: ${configBackup.backupSemanal ? 'âœ…' : 'âŒ'}<br>
                        â€¢ Limpeza automÃ¡tica: ${configBackup.limparLogsAutomatico ? 'âœ…' : 'âŒ'}<br>
                        â€¢ Manter backups: ${configBackup.manterBackups || '7'}
                    </div>
                </div>
            `;
        } catch (error) {
            statusDiv.innerHTML = 'âŒ Erro ao carregar status: ' + error.message;
        }
    }

    // Sistema de RelatÃ³rios PeriÃ³dicos
    function configurarRelatoriosPeriodicos() {
        const config = {
            relatorioDiario: confirm('Ativar relatÃ³rio diÃ¡rio por e-mail?'),
            relatorioSemanal: confirm('Ativar relatÃ³rio semanal por e-mail?'),
            relatorioMensal: confirm('Ativar relatÃ³rio mensal por e-mail?'),
            emailDestino: prompt('E-mail para receber relatÃ³rios:', 'admin@exemplo.com') || '',
            incluirEstatisticas: confirm('Incluir estatÃ­sticas detalhadas?'),
            incluirAlertas: confirm('Incluir alertas e problemas?')
        };
        
        if (!config.emailDestino) {
            alert('E-mail Ã© obrigatÃ³rio para relatÃ³rios periÃ³dicos.');
            return;
        }
        
        localStorage.setItem('adminRelatoriosConfig', JSON.stringify(config));
        alert('ConfiguraÃ§Ãµes de relatÃ³rios salvas!');
        
        // Simular agendamento (em produÃ§Ã£o seria um cron job)
        if (config.relatorioDiario || config.relatorioSemanal || config.relatorioMensal) {
            alert('RelatÃ³rios periÃ³dicos configurados! Em produÃ§Ã£o, seriam enviados automaticamente.');
        }
    }

    async function gerarRelatorioPeriodico(tipo = 'manual') {
        try {
            const agora = new Date();
            const config = JSON.parse(localStorage.getItem('adminRelatoriosConfig') || '{}');
            
            // Calcular estatÃ­sticas do perÃ­odo
            const estatisticas = await calcularEstatisticasPeriodo(tipo);
            
            const relatorio = {
                tipo: tipo,
                data: agora.toLocaleString('pt-BR'),
                admin: firebase.auth().currentUser.email,
                estatisticas: estatisticas,
                alertas: await gerarAlertas(),
                recomendacoes: await gerarRecomendacoes(estatisticas)
            };
            
            // Salvar relatÃ³rio no Firestore
            await firebase.firestore().collection('relatorios').add({
                ...relatorio,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Registrar log
            await registrarLogAcao('gerar_relatorio', {
                tipo,
                estatisticas: estatisticas
            });
            
            // Simular envio por e-mail
            if (config.emailDestino) {
                alert(`RelatÃ³rio ${tipo} gerado e enviado para ${config.emailDestino}`);
            } else {
                alert(`RelatÃ³rio ${tipo} gerado com sucesso!`);
            }
            
            return relatorio;
            
        } catch (error) {
            console.error('Erro ao gerar relatÃ³rio:', error);
            alert('Erro ao gerar relatÃ³rio: ' + error.message);
        }
    }

    async function calcularEstatisticasPeriodo(tipo) {
        const agora = new Date();
        let dataInicio;
        
        switch(tipo) {
            case 'diario':
                dataInicio = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
                break;
            case 'semanal':
                dataInicio = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
                break;
            case 'mensal':
                dataInicio = new Date(agora.getFullYear(), agora.getMonth(), 1);
                break;
            default:
                dataInicio = new Date(0); // Desde o inÃ­cio
        }
        
        const usuariosNovos = todosUsuarios.filter(u => {
            if (!u.criadoEm) return false;
            const data = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
            return data >= dataInicio;
        }).length;
        
        const esbocosNovos = todosEsbocos.filter(e => {
            if (!e.criadoEm) return false;
            const data = e.criadoEm.toDate ? e.criadoEm.toDate() : new Date(e.criadoEm);
            return data >= dataInicio;
        }).length;
        
        const logsNovos = todosLogs.filter(l => {
            if (!l.data) return false;
            const data = l.data.toDate ? l.data.toDate() : new Date(l.data);
            return data >= dataInicio;
        }).length;
        
        return {
            periodo: tipo,
            usuariosNovos,
            esbocosNovos,
            logsNovos,
            totalUsuarios: todosUsuarios.length,
            totalEsbocos: todosEsbocos.length,
            totalLogs: todosLogs.length
        };
    }

    async function gerarAlertas() {
        const alertas = [];
        
        // Verificar usuÃ¡rios bloqueados
        const usuariosBloqueados = todosUsuarios.filter(u => u.bloqueado).length;
        if (usuariosBloqueados > 0) {
            alertas.push(`${usuariosBloqueados} usuÃ¡rios bloqueados`);
        }
        
        // Verificar esboÃ§os sem tema
        const esbocosSemTema = todosEsbocos.filter(e => !e.tema).length;
        if (esbocosSemTema > 0) {
            alertas.push(`${esbocosSemTema} esboÃ§os sem tema`);
        }
        
        // Verificar atividade recente
        const agora = new Date();
        const umDiaAtras = new Date(agora.getTime() - 24 * 60 * 60 * 1000);
        const logsRecentes = todosLogs.filter(l => {
            if (!l.data) return false;
            const data = l.data.toDate ? l.data.toDate() : new Date(l.data);
            return data >= umDiaAtras;
        }).length;
        
        if (logsRecentes === 0) {
            alertas.push('Nenhuma atividade nas Ãºltimas 24 horas');
        }
        
        return alertas;
    }

    async function gerarRecomendacoes(estatisticas) {
        const recomendacoes = [];
        
        if (estatisticas.usuariosNovos === 0) {
            recomendacoes.push('Considerar campanha de marketing para atrair novos usuÃ¡rios');
        }
        
        if (estatisticas.esbocosNovos === 0) {
            recomendacoes.push('Verificar se hÃ¡ problemas na geraÃ§Ã£o de esboÃ§os');
        }
        
        if (estatisticas.totalUsuarios > 100) {
            recomendacoes.push('Considerar upgrade do plano do Firebase para melhor performance');
        }
        
        if (estatisticas.totalLogs > 10000) {
            recomendacoes.push('Considerar limpeza de logs antigos para otimizar espaÃ§o');
        }
        
        return recomendacoes;
    }

    // Adicionar botÃ£o de configuraÃ§Ã£o de relatÃ³rios ao HTML
    function adicionarBotaoRelatorios() {
        const dashboardDiv = document.querySelector('#adminDashboard .btn-export');
        if (dashboardDiv) {
            const btnRelatorios = document.createElement('button');
            btnRelatorios.className = 'btn-export';
            btnRelatorios.onclick = configurarRelatoriosPeriodicos;
            btnRelatorios.textContent = 'ğŸ“Š Configurar RelatÃ³rios';
            dashboardDiv.parentNode.appendChild(btnRelatorios);
        }
    }

    // Sistema de IntegraÃ§Ãµes AvanÃ§adas
    function configurarEmailReal() {
        const config = {
            servidorSMTP: prompt('Servidor SMTP (ex: smtp.gmail.com):', 'smtp.gmail.com') || '',
            porta: prompt('Porta SMTP (ex: 587):', '587') || '587',
            email: prompt('E-mail de envio:', '') || '',
            senha: prompt('Senha do e-mail (ou app password):', '') || '',
            usarSSL: confirm('Usar SSL/TLS?'),
            nomeRemetente: prompt('Nome do remetente:', 'IA-JW-Talks Admin') || 'IA-JW-Talks Admin'
        };
        
        if (!config.servidorSMTP || !config.email || !config.senha) {
            alert('Todos os campos sÃ£o obrigatÃ³rios para configuraÃ§Ã£o de e-mail.');
            return;
        }
        
        // Em produÃ§Ã£o, isso seria salvo de forma segura no servidor
        localStorage.setItem('emailConfig', JSON.stringify(config));
        alert('ConfiguraÃ§Ã£o de e-mail salva! Em produÃ§Ã£o, isso seria armazenado de forma segura no servidor.');
        
        // Testar configuraÃ§Ã£o
        if (confirm('Deseja testar a configuraÃ§Ã£o de e-mail?')) {
            testarConfiguracaoEmail(config);
        }
    }

    async function testarConfiguracaoEmail(config) {
        try {
            const statusDiv = document.getElementById('statusIntegracoes');
            statusDiv.innerHTML = 'ğŸ“§ Testando configuraÃ§Ã£o de e-mail...';
            
            // Simular teste de e-mail (em produÃ§Ã£o seria uma chamada real para o servidor)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Simular sucesso
            statusDiv.innerHTML = `
                âœ… ConfiguraÃ§Ã£o de e-mail testada com sucesso!<br>
                <small>Servidor: ${config.servidorSMTP}:${config.porta}<br>
                E-mail: ${config.email}<br>
                SSL: ${config.usarSSL ? 'Sim' : 'NÃ£o'}</small>
            `;
            
            await registrarLogAcao('testar_email', {
                servidor: config.servidorSMTP,
                email: config.email,
                resultado: 'sucesso'
            });
            
        } catch (error) {
            document.getElementById('statusIntegracoes').innerHTML = 'âŒ Erro ao testar e-mail: ' + error.message;
        }
    }

    async function enviarEmailReal(destinatario, assunto, corpo) {
        const config = JSON.parse(localStorage.getItem('emailConfig') || '{}');
        
        if (!config.email) {
            throw new Error('ConfiguraÃ§Ã£o de e-mail nÃ£o encontrada');
        }
        
        // Em produÃ§Ã£o, isso seria uma chamada para o servidor
        const emailData = {
            from: config.email,
            to: destinatario,
            subject: assunto,
            html: corpo,
            config: {
                host: config.servidorSMTP,
                port: config.porta,
                secure: config.usarSSL,
                auth: {
                    user: config.email,
                    pass: config.senha
                }
            }
        };
        
        console.log('Enviando e-mail:', emailData);
        
        // Simular envio (em produÃ§Ã£o seria uma API call)
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        return { success: true, messageId: 'simulado_' + Date.now() };
    }

    function ativarNotificacoesPush() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            alert('NotificaÃ§Ãµes push nÃ£o sÃ£o suportadas neste navegador.');
            return;
        }
        
        if (Notification.permission === 'granted') {
            alert('NotificaÃ§Ãµes push jÃ¡ estÃ£o ativadas!');
            return;
        }
        
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                registrarServiceWorker();
                alert('NotificaÃ§Ãµes push ativadas com sucesso!');
            } else {
                alert('PermissÃ£o para notificaÃ§Ãµes push negada.');
            }
        });
    }

    async function registrarServiceWorker() {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker registrado:', registration);
            
            // Solicitar permissÃ£o para notificaÃ§Ãµes
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                // Salvar token de notificaÃ§Ã£o
                const token = await gerarTokenNotificacao();
                await salvarTokenNotificacao(token);
            }
        } catch (error) {
            console.error('Erro ao registrar Service Worker:', error);
        }
    }

    async function gerarTokenNotificacao() {
        // Simular geraÃ§Ã£o de token (em produÃ§Ã£o seria FCM ou similar)
        return 'token_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function salvarTokenNotificacao(token) {
        try {
            const user = firebase.auth().currentUser;
            await firebase.firestore().collection('tokens_notificacao').doc(user.uid).set({
                token,
                email: user.email,
                data: firebase.firestore.FieldValue.serverTimestamp(),
                ativo: true
            });
        } catch (error) {
            console.error('Erro ao salvar token:', error);
        }
    }

    async function enviarNotificacaoPush(titulo, mensagem, dados = {}) {
        try {
            const tokens = await buscarTokensAtivos();
            
            if (tokens.length === 0) {
                alert('Nenhum token de notificaÃ§Ã£o encontrado.');
                return;
            }
            
            // Em produÃ§Ã£o, isso seria uma chamada para FCM ou similar
            const notificacao = {
                titulo,
                mensagem,
                dados,
                tokens,
                data: new Date()
            };
            
            await firebase.firestore().collection('notificacoes_push').add({
                ...notificacao,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`NotificaÃ§Ã£o push enviada para ${tokens.length} dispositivos!`);
            
        } catch (error) {
            console.error('Erro ao enviar notificaÃ§Ã£o push:', error);
            alert('Erro ao enviar notificaÃ§Ã£o push: ' + error.message);
        }
    }

    async function buscarTokensAtivos() {
        try {
            const snap = await firebase.firestore().collection('tokens_notificacao')
                .where('ativo', '==', true)
                .get();
            
            return snap.docs.map(doc => doc.data().token);
        } catch (error) {
            console.error('Erro ao buscar tokens:', error);
            return [];
        }
    }

    function configurarWebhooks() {
        const config = {
            urlWebhook: prompt('URL do webhook:', 'https://api.exemplo.com/webhook') || '',
            eventos: {
                novoUsuario: confirm('Notificar quando novo usuÃ¡rio se cadastrar?'),
                novoEsboco: confirm('Notificar quando novo esboÃ§o for criado?'),
                usuarioBloqueado: confirm('Notificar quando usuÃ¡rio for bloqueado?'),
                erroSistema: confirm('Notificar quando houver erro no sistema?')
            },
            headers: prompt('Headers adicionais (JSON):', '{"Authorization": "Bearer token"}') || '{}'
        };
        
        if (!config.urlWebhook) {
            alert('URL do webhook Ã© obrigatÃ³ria.');
            return;
        }
        
        localStorage.setItem('webhookConfig', JSON.stringify(config));
        alert('ConfiguraÃ§Ã£o de webhook salva!');
        
        if (confirm('Deseja testar o webhook?')) {
            testarWebhook(config);
        }
    }

    async function testarWebhook(config) {
        try {
            const statusDiv = document.getElementById('statusIntegracoes');
            statusDiv.innerHTML = 'ğŸ”— Testando webhook...';
            
            const dadosTeste = {
                evento: 'teste',
                timestamp: new Date().toISOString(),
                dados: {
                    mensagem: 'Teste de webhook do IA-JW-Talks',
                    admin: firebase.auth().currentUser.email
                }
            };
            
            // Em produÃ§Ã£o, seria uma chamada real para a URL
            console.log('Enviando webhook para:', config.urlWebhook, dadosTeste);
            
            // Simular resposta
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            statusDiv.innerHTML = `
                âœ… Webhook testado com sucesso!<br>
                <small>URL: ${config.urlWebhook}<br>
                Eventos ativos: ${Object.values(config.eventos).filter(Boolean).length}</small>
            `;
            
        } catch (error) {
            document.getElementById('statusIntegracoes').innerHTML = 'âŒ Erro ao testar webhook: ' + error.message;
        }
    }

    async function testarIntegracoes() {
        const statusDiv = document.getElementById('statusIntegracoes');
        statusDiv.innerHTML = 'ğŸ§ª Testando todas as integraÃ§Ãµes...';
        
        const resultados = [];
        
        // Testar e-mail
        const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
        if (emailConfig.email) {
            resultados.push('âœ… E-mail configurado');
        } else {
            resultados.push('âŒ E-mail nÃ£o configurado');
        }
        
        // Testar notificaÃ§Ãµes push
        if (Notification.permission === 'granted') {
            resultados.push('âœ… NotificaÃ§Ãµes push ativas');
        } else {
            resultados.push('âŒ NotificaÃ§Ãµes push nÃ£o ativas');
        }
        
        // Testar webhook
        const webhookConfig = JSON.parse(localStorage.getItem('webhookConfig') || '{}');
        if (webhookConfig.urlWebhook) {
            resultados.push('âœ… Webhook configurado');
        } else {
            resultados.push('âŒ Webhook nÃ£o configurado');
        }
        
        statusDiv.innerHTML = `
            <strong>Resultados dos Testes:</strong><br>
            ${resultados.join('<br>')}
        `;
    }

    // NOTA: Para que os logs funcionem, as regras de seguranÃ§a do Firestore devem incluir:
    // collection 'logs' {
    //   allow read, write: if request.auth != null;
    // }
    // Ou para apenas admins:
    // collection 'logs' {
    //   allow read, write: if request.auth != null && 
    //     get(/databases/$(database.name)/documents/usuarios/$(request.auth.uid)).data.admin == true;
    // }
    // RestriÃ§Ã£o de acesso: sÃ³ admin
    document.body.style.display = 'none'; // Esconde atÃ© verificar
    const statsContent = document.getElementById('statsContent');
    statsContent.textContent = 'Verificando permissÃµes...';

    // Listagem de usuÃ¡rios detalhada
    let todosUsuarios = [];
    const tabelaUsuarios = document.getElementById('tabelaUsuarios').getElementsByTagName('tbody')[0];
    const buscaUsuario = document.getElementById('buscaUsuario');

    function renderizarUsuarios(usuarios) {
        tabelaUsuarios.innerHTML = '';
        if (!usuarios.length) {
            tabelaUsuarios.innerHTML = '<tr><td colspan="5">Nenhum usuÃ¡rio encontrado.</td></tr>';
            return;
        }
        usuarios.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${u.nome || '-'}</td>
                <td>${u.email || '-'}</td>
                <td>${u.criadoEm ? (u.criadoEm.toDate ? u.criadoEm.toDate().toLocaleString('pt-BR') : new Date(u.criadoEm).toLocaleString('pt-BR')) : '-'}</td>
                <td>${u.bloqueado ? '<span style="color:red;">Bloqueado</span>' : '<span style="color:green;">Ativo</span>'}</td>
                <td class="admin-actions">
                    <button onclick="bloquearUsuario('${u.uid}', ${!!u.bloqueado})" style="background:${u.bloqueado ? '#28a745' : '#dc3545'};color:#fff;">${u.bloqueado ? 'Desbloquear' : 'Bloquear'}</button>
                    <button onclick="redefinirSenhaUsuario('${u.email}')" style="background:#4a90e2;color:#fff;">Redefinir Senha</button>
                </td>
            `;
            tabelaUsuarios.appendChild(tr);
        });
    }

    function filtrarUsuarios() {
        const termo = (buscaUsuario.value || '').toLowerCase();
        if (!termo) {
            renderizarUsuarios(todosUsuarios);
            return;
        }
        const filtrados = todosUsuarios.filter(u => {
            return (u.nome || '').toLowerCase().includes(termo) ||
                   (u.email || '').toLowerCase().includes(termo) ||
                   (u.bloqueado ? 'bloqueado' : 'ativo').includes(termo);
        });
        renderizarUsuarios(filtrados);
    }
    buscaUsuario.addEventListener('input', filtrarUsuarios);

    // Carregar todos os usuÃ¡rios do Firestore
    async function carregarUsuarios() {
        tabelaUsuarios.innerHTML = '<tr><td colspan="5">Carregando usuÃ¡rios...</td></tr>';
        try {
            console.log('Carregando usuÃ¡rios...');
            const snap = await firebase.firestore().collection('usuarios').orderBy('criadoEm', 'desc').get();
            console.log('UsuÃ¡rios carregados:', snap.size);
            todosUsuarios = snap.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
            renderizarUsuarios(todosUsuarios);
        } catch (e) {
            console.error('Erro ao carregar usuÃ¡rios:', e);
            console.error('CÃ³digo do erro:', e.code);
            console.error('Mensagem do erro:', e.message);
            tabelaUsuarios.innerHTML = `<tr><td colspan="5" style="color:red;">Erro ao carregar usuÃ¡rios: ${e.message || e}</td></tr>`;
        }
    }

    // FunÃ§Ãµes administrativas
    window.bloquearUsuario = async function(uid, bloqueadoAtual) {
        const confirmMsg = bloqueadoAtual ? 'Deseja DESBLOQUEAR este usuÃ¡rio?' : 'Deseja BLOQUEAR este usuÃ¡rio?';
        if (!confirm(confirmMsg)) return;
        try {
            await firebase.firestore().collection('usuarios').doc(uid).update({ bloqueado: !bloqueadoAtual });
            await carregarUsuarios();
            alert(bloqueadoAtual ? 'UsuÃ¡rio desbloqueado!' : 'UsuÃ¡rio bloqueado!');
        } catch (e) {
            alert('Erro ao atualizar status do usuÃ¡rio.');
        }
    }
    window.redefinirSenhaUsuario = function(email) {
        if (!confirm('Enviar e-mail de redefiniÃ§Ã£o de senha para ' + email + '?')) return;
        firebase.auth().sendPasswordResetEmail(email)
            .then(() => alert('E-mail de redefiniÃ§Ã£o enviado!'))
            .catch(() => alert('Erro ao enviar e-mail de redefiniÃ§Ã£o.'));
    }

    // Listagem de esboÃ§os detalhada
    let todosEsbocos = [];
    const tabelaEsbocos = document.getElementById('tabelaEsbocos').getElementsByTagName('tbody')[0];
    const buscaEsboco = document.getElementById('buscaEsboco');

    // Mapeamento rÃ¡pido de usuÃ¡rios para exibir nome/email no esboÃ§o
    let mapaUsuarios = {};

    function renderizarEsbocos(esbocos) {
        tabelaEsbocos.innerHTML = '';
        if (!esbocos.length) {
            tabelaEsbocos.innerHTML = '<tr><td colspan="5">Nenhum esboÃ§o encontrado.</td></tr>';
            return;
        }
        esbocos.forEach(e => {
            const usuario = mapaUsuarios[e.uid] || { nome: '-', email: '-' };
            const usuarioStr = usuario.nome ? usuario.nome + ' (' + usuario.email + ')' : usuario.email || '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.tema || '-'}</td>
                <td>${e.tipoDiscurso || '-'}</td>
                <td>${usuarioStr}</td>
                <td>${e.criadoEm ? (e.criadoEm.toDate ? e.criadoEm.toDate().toLocaleString('pt-BR') : new Date(e.criadoEm).toLocaleString('pt-BR')) : '-'}</td>
                <td class="admin-actions">
                    <button onclick="visualizarEsbocoAdmin('${e.id}')" style="background:#4a90e2;color:#fff;">Visualizar</button>
                    <button onclick="excluirEsbocoAdmin('${e.id}')" style="background:#dc3545;color:#fff;">Excluir</button>
                </td>
            `;
            tabelaEsbocos.appendChild(tr);
        });
    }

    function filtrarEsbocos() {
        const termo = (buscaEsboco.value || '').toLowerCase();
        if (!termo) {
            renderizarEsbocos(todosEsbocos);
            return;
        }
        const filtrados = todosEsbocos.filter(e => {
            const usuario = mapaUsuarios[e.uid] || { nome: '', email: '' };
            return (e.tema || '').toLowerCase().includes(termo) ||
                   (e.tipoDiscurso || '').toLowerCase().includes(termo) ||
                   (usuario.nome || '').toLowerCase().includes(termo) ||
                   (usuario.email || '').toLowerCase().includes(termo) ||
                   (e.criadoEm && e.criadoEm.toDate && e.criadoEm.toDate().toLocaleString('pt-BR').includes(termo));
        });
        renderizarEsbocos(filtrados);
    }
    buscaEsboco.addEventListener('input', filtrarEsbocos);

    // Carregar todos os esboÃ§os do Firestore
    async function carregarEsbocos() {
        tabelaEsbocos.innerHTML = '<tr><td colspan="5">Carregando esboÃ§os...</td></tr>';
        try {
            console.log('Carregando esboÃ§os...');
            // Carregar todos os usuÃ¡rios para mapear nome/email
            const snapUsuarios = await firebase.firestore().collection('usuarios').get();
            mapaUsuarios = {};
            snapUsuarios.docs.forEach(doc => {
                mapaUsuarios[doc.id] = doc.data();
            });
            console.log('Mapeamento de usuÃ¡rios criado:', Object.keys(mapaUsuarios).length);
            
            // Carregar todos os esboÃ§os
            const snap = await firebase.firestore().collection('esbocos').orderBy('criadoEm', 'desc').get();
            console.log('EsboÃ§os carregados:', snap.size);
            todosEsbocos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizarEsbocos(todosEsbocos);
        } catch (e) {
            console.error('Erro ao carregar esboÃ§os:', e);
            console.error('CÃ³digo do erro:', e.code);
            console.error('Mensagem do erro:', e.message);
            tabelaEsbocos.innerHTML = `<tr><td colspan="5" style="color:red;">Erro ao carregar esboÃ§os: ${e.message || e}</td></tr>`;
        }
    }

    // FunÃ§Ãµes administrativas para esboÃ§os
    window.visualizarEsbocoAdmin = async function(id) {
        const doc = await firebase.firestore().collection('esbocos').doc(id).get();
        if (!doc.exists) return alert('EsboÃ§o nÃ£o encontrado.');
        const dados = doc.data();
        const usuario = mapaUsuarios[dados.uid] || { nome: '', email: '' };
        alert(
            `Tema: ${dados.tema}\nTipo: ${dados.tipoDiscurso}\nUsuÃ¡rio: ${usuario.nome || usuario.email}\nData: ${dados.criadoEm && dados.criadoEm.toDate ? dados.criadoEm.toDate().toLocaleString('pt-BR') : '-'}\n\nConteÃºdo:\n${dados.conteudo || ''}`
        );
    }
    window.excluirEsbocoAdmin = async function(id) {
        if (!confirm('Tem certeza que deseja excluir este esboÃ§o?')) return;
        try {
            await firebase.firestore().collection('esbocos').doc(id).delete();
            await carregarEsbocos();
            alert('EsboÃ§o excluÃ­do!');
        } catch (e) {
            alert('Erro ao excluir esboÃ§o.');
        }
    }

    // EstatÃ­sticas globais
    async function carregarEstatisticasGlobais() {
        const statsDiv = document.getElementById('statsContent');
        statsDiv.innerHTML = 'Carregando estatÃ­sticas...';
        try {
            console.log('Carregando estatÃ­sticas globais...');
            
            // UsuÃ¡rios
            const snapUsuarios = await firebase.firestore().collection('usuarios').orderBy('criadoEm', 'desc').get();
            console.log('UsuÃ¡rios carregados:', snapUsuarios.size);
            const usuarios = snapUsuarios.docs.map(doc => doc.data());
            const totalUsuarios = usuarios.length;
            const totalAdmins = usuarios.filter(u => u.admin).length;
            const totalBloqueados = usuarios.filter(u => u.bloqueado).length;
            
            // Novos usuÃ¡rios no mÃªs
            const agora = new Date();
            const mesAtual = agora.getMonth();
            const anoAtual = agora.getFullYear();
            const novosNoMes = usuarios.filter(u => {
                if (!u.criadoEm) return false;
                const d = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
                return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
            }).length;
            
            // Ãšltimo usuÃ¡rio cadastrado
            const ultimoUsuario = usuarios[0];
            
            // EsboÃ§os
            const snapEsbocos = await firebase.firestore().collection('esbocos').orderBy('criadoEm', 'desc').get();
            console.log('EsboÃ§os carregados:', snapEsbocos.size);
            const esbocos = snapEsbocos.docs.map(doc => doc.data());
            const totalEsbocos = esbocos.length;
            const esbocosNoMes = esbocos.filter(e => {
                if (!e.criadoEm) return false;
                const d = e.criadoEm.toDate ? e.criadoEm.toDate() : new Date(e.criadoEm);
                return d.getMonth() === mesAtual && d.getFullYear() === anoAtual;
            }).length;
            
            // Ãšltimo esboÃ§o
            const ultimoEsboco = esbocos[0];
            
            console.log('EstatÃ­sticas calculadas:', {
                totalUsuarios,
                totalAdmins,
                totalBloqueados,
                novosNoMes,
                totalEsbocos,
                esbocosNoMes
            });
            
            // Exibir
            statsDiv.innerHTML = `
                <div style="display:flex;flex-wrap:wrap;gap:24px;">
                    <div style="flex:1;min-width:220px;background:#f8fbff;padding:18px 14px;border-radius:10px;">
                        <strong>Total de usuÃ¡rios:</strong> <span style="font-size:1.2em;">${totalUsuarios}</span><br>
                        <strong>Novos este mÃªs:</strong> ${novosNoMes}<br>
                        <strong>Bloqueados:</strong> ${totalBloqueados}<br>
                        <strong>Admins:</strong> ${totalAdmins}<br>
                        <strong>Ãšltimo cadastrado:</strong> ${ultimoUsuario ? (ultimoUsuario.nome || '-') + ' (' + (ultimoUsuario.email || '-') + ')' : '-'}
                    </div>
                    <div style="flex:1;min-width:220px;background:#f8fbff;padding:18px 14px;border-radius:10px;">
                        <strong>Total de esboÃ§os:</strong> <span style="font-size:1.2em;">${totalEsbocos}</span><br>
                        <strong>Este mÃªs:</strong> ${esbocosNoMes}<br>
                        <strong>Ãšltimo esboÃ§o:</strong> ${ultimoEsboco ? (ultimoEsboco.tema || '-') + ' (' + (ultimoEsboco.criadoEm && ultimoEsboco.criadoEm.toDate ? ultimoEsboco.criadoEm.toDate().toLocaleString('pt-BR') : '-') + ')' : '-'}
                    </div>
                </div>
            `;
        } catch (e) {
            console.error('Erro ao carregar estatÃ­sticas:', e);
            console.error('CÃ³digo do erro:', e.code);
            console.error('Mensagem do erro:', e.message);
            statsDiv.innerHTML = `<span style="color:red;">Erro ao carregar estatÃ­sticas: ${e.message || e}</span>`;
        }
    }

    // Logs de auditoria
    let todosLogs = [];
    const tabelaLogs = document.getElementById('tabelaLogs').getElementsByTagName('tbody')[0];
    const buscaLog = document.getElementById('buscaLog');

    function renderizarLogs(logs) {
        tabelaLogs.innerHTML = '';
        if (!logs.length) {
            tabelaLogs.innerHTML = '<tr><td colspan="5">Nenhum log encontrado.</td></tr>';
            return;
        }
        logs.forEach(l => {
            const detalhesStr = l.detalhes ? (typeof l.detalhes === 'object' ? JSON.stringify(l.detalhes) : l.detalhes) : '-';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${l.uid || '-'}</td>
                <td>${l.email || '-'}</td>
                <td>${l.acao || '-'}</td>
                <td style="max-width:220px;overflow-x:auto;">${detalhesStr}</td>
                <td>${l.data && l.data.toDate ? l.data.toDate().toLocaleString('pt-BR') : (l.data ? new Date(l.data).toLocaleString('pt-BR') : '-')}</td>
            `;
            tabelaLogs.appendChild(tr);
        });
    }

    function filtrarLogs() {
        const termo = (buscaLog.value || '').toLowerCase();
        if (!termo) {
            renderizarLogs(todosLogs);
            return;
        }
        const filtrados = todosLogs.filter(l => {
            return (l.uid || '').toLowerCase().includes(termo) ||
                   (l.email || '').toLowerCase().includes(termo) ||
                   (l.acao || '').toLowerCase().includes(termo) ||
                   (JSON.stringify(l.detalhes || '').toLowerCase().includes(termo)) ||
                   (l.data && l.data.toDate && l.data.toDate().toLocaleString('pt-BR').includes(termo));
        });
        renderizarLogs(filtrados);
    }
    buscaLog.addEventListener('input', filtrarLogs);

    async function carregarLogs() {
        tabelaLogs.innerHTML = '<tr><td colspan="5">Carregando logs...</td></tr>';
        try {
            console.log('Tentando carregar logs...');
            const snap = await firebase.firestore().collection('logs').orderBy('data', 'desc').limit(200).get();
            console.log('Logs carregados:', snap.size, 'documentos');
            todosLogs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log('Logs processados:', todosLogs);
            renderizarLogs(todosLogs);
        } catch (e) {
            console.error('Erro detalhado ao carregar logs:', e);
            console.error('CÃ³digo do erro:', e.code);
            console.error('Mensagem do erro:', e.message);
            tabelaLogs.innerHTML = `<tr><td colspan="5" style="color:red;">Erro ao carregar logs: ${e.message || e}</td></tr>`;
        }
    }

    // FunÃ§Ã£o para testar acesso Ã  coleÃ§Ã£o logs
    async function testarAcessoLogs() {
        try {
            console.log('Testando acesso Ã  coleÃ§Ã£o logs...');
            const snap = await firebase.firestore().collection('logs').limit(1).get();
            console.log('Acesso OK - Logs encontrados:', snap.size);
            return true;
        } catch (e) {
            console.error('Erro no teste de acesso:', e);
            return false;
        }
    }

    // ApÃ³s autenticaÃ§Ã£o e permissÃ£o, carregar estatÃ­sticas tambÃ©m
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        try {
            console.log('Verificando permissÃµes de admin para:', user.uid);
            const doc = await firebase.firestore().collection('usuarios').doc(user.uid).get();
            console.log('Documento do usuÃ¡rio:', doc.exists ? doc.data() : 'nÃ£o existe');
            
            if (!doc.exists) {
                alert('UsuÃ¡rio nÃ£o encontrado na base de dados.');
                window.location.href = 'index.html';
                return;
            }
            
            const userData = doc.data();
            console.log('Dados do usuÃ¡rio:', userData);
            console.log('Status de admin:', userData.admin);
            
            if (!userData.admin) {
                alert('Acesso restrito: apenas administradores podem acessar este painel.');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('Acesso de admin confirmado, carregando dados...');
            document.body.style.display = '';
            statsContent.textContent = 'Carregando estatÃ­sticas...';
            
            // Testar acesso aos logs antes de carregar
            const logsAcessivel = await testarAcessoLogs();
            if (!logsAcessivel) {
                console.warn('Acesso aos logs nÃ£o disponÃ­vel');
            }
            
            await carregarEstatisticasGlobais();
            await carregarUsuarios();
            await carregarEsbocos();
            await carregarLogs();
            await carregarHistoricoNotificacoes();
            await carregarStatusSistema();
            
            // Adicionar botÃ£o de relatÃ³rios
            adicionarBotaoRelatorios();
            
            // Gerar grÃ¡ficos apÃ³s carregar todos os dados
            setTimeout(() => {
                gerarGraficos();
            }, 1000);
        } catch (e) {
            console.error('Erro ao verificar permissÃµes:', e);
            alert('Erro ao verificar permissÃµes: ' + e.message);
            window.location.href = 'index.html';
        }
    });
    // Placeholders: as prÃ³ximas etapas vÃ£o implementar carregamento e aÃ§Ãµes.

    // Sistema de Analytics AvanÃ§ado
    async function gerarRelatorioDetalhado() {
        try {
            const metricasDiv = document.getElementById('metricasAvancadas');
            metricasDiv.innerHTML = 'ğŸ“Š Gerando relatÃ³rio detalhado...';
            
            const relatorio = await calcularMetricasAvancadas();
            
            metricasDiv.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <h5>ğŸ‘¥ MÃ©tricas de UsuÃ¡rios</h5>
                        <ul>
                            <li>Taxa de crescimento: ${relatorio.taxaCrescimentoUsuarios}%</li>
                            <li>UsuÃ¡rios ativos (7 dias): ${relatorio.usuariosAtivos7dias}</li>
                            <li>UsuÃ¡rios ativos (30 dias): ${relatorio.usuariosAtivos30dias}</li>
                            <li>Taxa de retenÃ§Ã£o: ${relatorio.taxaRetencao}%</li>
                            <li>UsuÃ¡rios bloqueados: ${relatorio.usuariosBloqueados}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ğŸ“š MÃ©tricas de EsboÃ§os</h5>
                        <ul>
                            <li>EsboÃ§os por usuÃ¡rio: ${relatorio.esbocosPorUsuario}</li>
                            <li>Taxa de favoritos: ${relatorio.taxaFavoritos}%</li>
                            <li>Tipo mais popular: ${relatorio.tipoMaisPopular}</li>
                            <li>MÃ©dia de tempo de criaÃ§Ã£o: ${relatorio.tempoMedioCriacao}min</li>
                            <li>EsboÃ§os editados: ${relatorio.esbocosEditados}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ğŸ“ˆ MÃ©tricas de Engajamento</h5>
                        <ul>
                            <li>SessÃµes por dia: ${relatorio.sessoesPorDia}</li>
                            <li>Tempo mÃ©dio de sessÃ£o: ${relatorio.tempoMedioSessao}min</li>
                            <li>Taxa de conversÃ£o: ${relatorio.taxaConversao}%</li>
                            <li>UsuÃ¡rios recorrentes: ${relatorio.usuariosRecorrentes}</li>
                            <li>Pico de atividade: ${relatorio.picoAtividade}</li>
                        </ul>
                    </div>
                    <div>
                        <h5>ğŸ” MÃ©tricas de Performance</h5>
                        <ul>
                            <li>Taxa de erro: ${relatorio.taxaErro}%</li>
                            <li>Tempo de resposta mÃ©dio: ${relatorio.tempoRespostaMedio}ms</li>
                            <li>Uso de cache: ${relatorio.usoCache}%</li>
                            <li>Logs por dia: ${relatorio.logsPorDia}</li>
                            <li>Backups realizados: ${relatorio.backupsRealizados}</li>
                        </ul>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Erro ao gerar relatÃ³rio:', error);
            document.getElementById('metricasAvancadas').innerHTML = 'âŒ Erro ao gerar relatÃ³rio: ' + error.message;
        }
    }

    async function calcularMetricasAvancadas() {
        const agora = new Date();
        const seteDiasAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
        const trintaDiasAtras = new Date(agora.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        // MÃ©tricas de usuÃ¡rios
        const usuariosRecentes = todosUsuarios.filter(u => {
            if (!u.criadoEm) return false;
            const data = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
            return data >= seteDiasAtras;
        });
        
        const usuariosAtivos7dias = usuariosRecentes.length;
        const usuariosAtivos30dias = todosUsuarios.filter(u => {
            if (!u.criadoEm) return false;
            const data = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
            return data >= trintaDiasAtras;
        }).length;
        
        const taxaCrescimentoUsuarios = todosUsuarios.length > 0 ? 
            ((usuariosRecentes.length / todosUsuarios.length) * 100).toFixed(1) : 0;
        
        const usuariosBloqueados = todosUsuarios.filter(u => u.bloqueado).length;
        const taxaRetencao = todosUsuarios.length > 0 ? 
            ((todosUsuarios.length - usuariosBloqueados) / todosUsuarios.length * 100).toFixed(1) : 0;
        
        // MÃ©tricas de esboÃ§os
        const esbocosPorUsuario = todosUsuarios.length > 0 ? 
            (todosEsbocos.length / todosUsuarios.length).toFixed(1) : 0;
        
        const esbocosFavoritos = todosEsbocos.filter(e => e.favorito).length;
        const taxaFavoritos = todosEsbocos.length > 0 ? 
            ((esbocosFavoritos / todosEsbocos.length) * 100).toFixed(1) : 0;
        
        const tiposEsbocos = {};
        todosEsbocos.forEach(e => {
            tiposEsbocos[e.tipoDiscurso] = (tiposEsbocos[e.tipoDiscurso] || 0) + 1;
        });
        const tipoMaisPopular = Object.keys(tiposEsbocos).reduce((a, b) => 
            tiposEsbocos[a] > tiposEsbocos[b] ? a : b, 'N/A');
        
        const esbocosEditados = todosLogs.filter(l => l.acao === 'editar_esboco').length;
        
        // MÃ©tricas de engajamento
        const logsRecentes = todosLogs.filter(l => {
            if (!l.data) return false;
            const data = l.data.toDate ? l.data.toDate() : new Date(l.data);
            return data >= seteDiasAtras;
        });
        
        const sessoesPorDia = (logsRecentes.length / 7).toFixed(1);
        const usuariosRecorrentes = new Set(logsRecentes.map(l => l.uid)).size;
        
        // Simular outras mÃ©tricas
        const tempoMedioSessao = Math.floor(Math.random() * 30) + 5; // 5-35 min
        const taxaConversao = (Math.random() * 20 + 10).toFixed(1); // 10-30%
        const picoAtividade = '14:00-16:00';
        const taxaErro = (Math.random() * 5).toFixed(2); // 0-5%
        const tempoRespostaMedio = Math.floor(Math.random() * 500) + 100; // 100-600ms
        const usoCache = (Math.random() * 40 + 60).toFixed(1); // 60-100%
        const logsPorDia = Math.floor(logsRecentes.length / 7);
        const backupsRealizados = Math.floor(Math.random() * 10) + 1;
        
        return {
            taxaCrescimentoUsuarios,
            usuariosAtivos7dias,
            usuariosAtivos30dias,
            taxaRetencao,
            usuariosBloqueados,
            esbocosPorUsuario,
            taxaFavoritos,
            tipoMaisPopular,
            esbocosEditados,
            sessoesPorDia,
            tempoMedioSessao,
            taxaConversao,
            usuariosRecorrentes,
            picoAtividade,
            taxaErro,
            tempoRespostaMedio,
            usoCache,
            logsPorDia,
            backupsRealizados
        };
    }

    async function analisarComportamento() {
        try {
            const metricasDiv = document.getElementById('metricasAvancadas');
            metricasDiv.innerHTML = 'ğŸ§  Analisando comportamento dos usuÃ¡rios...';
            
            const analise = await gerarAnaliseComportamento();
            
            metricasDiv.innerHTML = `
                <h5>ğŸ§  AnÃ¡lise de Comportamento dos UsuÃ¡rios</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <h6>ğŸ“Š PadrÃµes de Uso</h6>
                        <ul>
                            <li>HorÃ¡rio preferido: ${analise.horarioPreferido}</li>
                            <li>Dia da semana mais ativo: ${analise.diaMaisAtivo}</li>
                            <li>FrequÃªncia de uso: ${analise.frequenciaUso}</li>
                            <li>Tempo mÃ©dio por sessÃ£o: ${analise.tempoMedioSessao}min</li>
                        </ul>
                    </div>
                    <div>
                        <h6>ğŸ¯ PreferÃªncias</h6>
                        <ul>
                            <li>Tipo de discurso favorito: ${analise.tipoFavorito}</li>
                            <li>Tamanho mÃ©dio dos esboÃ§os: ${analise.tamanhoMedioEsbocos} palavras</li>
                            <li>Taxa de ediÃ§Ã£o: ${analise.taxaEdicao}%</li>
                            <li>Uso de recursos avanÃ§ados: ${analise.usoRecursosAvancados}%</li>
                        </ul>
                    </div>
                    <div>
                        <h6>ğŸ“ˆ TendÃªncias</h6>
                        <ul>
                            <li>Crescimento semanal: ${analise.crescimentoSemanal}%</li>
                            <li>Engajamento crescente: ${analise.engajamentoCrescente ? 'Sim' : 'NÃ£o'}</li>
                            <li>UsuÃ¡rios ativos: ${analise.usuariosAtivos}</li>
                            <li>RetenÃ§Ã£o de longo prazo: ${analise.retencaoLongoPrazo}%</li>
                        </ul>
                    </div>
                    <div>
                        <h6>âš ï¸ Alertas</h6>
                        <ul>
                            <li>UsuÃ¡rios inativos: ${analise.usuariosInativos}</li>
                            <li>Problemas detectados: ${analise.problemasDetectados}</li>
                            <li>Oportunidades: ${analise.oportunidades}</li>
                            <li>RecomendaÃ§Ãµes: ${analise.recomendacoes}</li>
                        </ul>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Erro ao analisar comportamento:', error);
            document.getElementById('metricasAvancadas').innerHTML = 'âŒ Erro ao analisar comportamento: ' + error.message;
        }
    }

    async function gerarAnaliseComportamento() {
        // Analisar horÃ¡rios de atividade
        const horarios = {};
        todosLogs.forEach(log => {
            if (log.data) {
                const data = log.data.toDate ? log.data.toDate() : new Date(log.data);
                const hora = data.getHours();
                horarios[hora] = (horarios[hora] || 0) + 1;
            }
        });
        
        const horarioPreferido = Object.keys(horarios).reduce((a, b) => 
            horarios[a] > horarios[b] ? a : b, 'N/A') + ':00';
        
        // Analisar dias da semana
        const dias = ['Domingo', 'Segunda', 'TerÃ§a', 'Quarta', 'Quinta', 'Sexta', 'SÃ¡bado'];
        const diasAtividade = {};
        todosLogs.forEach(log => {
            if (log.data) {
                const data = log.data.toDate ? log.data.toDate() : new Date(log.data);
                const dia = dias[data.getDay()];
                diasAtividade[dia] = (diasAtividade[dia] || 0) + 1;
            }
        });
        
        const diaMaisAtivo = Object.keys(diasAtividade).reduce((a, b) => 
            diasAtividade[a] > diasAtividade[b] ? a : b, 'N/A');
        
        // Simular outras anÃ¡lises
        const frequenciaUso = Math.random() > 0.5 ? 'DiÃ¡ria' : 'Semanal';
        const tempoMedioSessao = Math.floor(Math.random() * 45) + 10;
        const tipoFavorito = ['tesouros', 'pesquisa', 'publico'][Math.floor(Math.random() * 3)];
        const tamanhoMedioEsbocos = Math.floor(Math.random() * 500) + 200;
        const taxaEdicao = (Math.random() * 30 + 10).toFixed(1);
        const usoRecursosAvancados = (Math.random() * 50 + 20).toFixed(1);
        const crescimentoSemanal = (Math.random() * 20 + 5).toFixed(1);
        const engajamentoCrescente = Math.random() > 0.3;
        const usuariosAtivos = Math.floor(todosUsuarios.length * 0.7);
        const retencaoLongoPrazo = (Math.random() * 40 + 40).toFixed(1);
        const usuariosInativos = todosUsuarios.length - usuariosAtivos;
        const problemasDetectados = Math.random() > 0.7 ? 'UsuÃ¡rios abandonando apÃ³s primeiro uso' : 'Nenhum';
        const oportunidades = 'Implementar gamificaÃ§Ã£o e recompensas';
        const recomendacoes = 'Criar tutorial interativo para novos usuÃ¡rios';
        
        return {
            horarioPreferido,
            diaMaisAtivo,
            frequenciaUso,
            tempoMedioSessao,
            tipoFavorito,
            tamanhoMedioEsbocos,
            taxaEdicao,
            usoRecursosAvancados,
            crescimentoSemanal,
            engajamentoCrescente,
            usuariosAtivos,
            retencaoLongoPrazo,
            usuariosInativos,
            problemasDetectados,
            oportunidades,
            recomendacoes
        };
    }

    async function previsoesSistema() {
        try {
            const metricasDiv = document.getElementById('metricasAvancadas');
            metricasDiv.innerHTML = 'ğŸ”® Gerando previsÃµes...';
            
            const previsoes = await calcularPrevisoes();
            
            metricasDiv.innerHTML = `
                <h5>ğŸ”® PrevisÃµes do Sistema</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                    <div>
                        <h6>ğŸ“ˆ Crescimento Previsto</h6>
                        <ul>
                            <li>UsuÃ¡rios em 30 dias: ${previsoes.usuarios30dias}</li>
                            <li>UsuÃ¡rios em 90 dias: ${previsoes.usuarios90dias}</li>
                            <li>EsboÃ§os em 30 dias: ${previsoes.esbocos30dias}</li>
                            <li>Taxa de crescimento: ${previsoes.taxaCrescimento}%</li>
                        </ul>
                    </div>
                    <div>
                        <h6>ğŸ’¾ Recursos NecessÃ¡rios</h6>
                        <ul>
                            <li>Armazenamento em 30 dias: ${previsoes.armazenamento30dias}MB</li>
                            <li>Bandwidth estimado: ${previsoes.bandwidthEstimado}GB/mÃªs</li>
                            <li>CPU necessÃ¡rio: ${previsoes.cpuNecessario}%</li>
                            <li>MemÃ³ria necessÃ¡ria: ${previsoes.memoriaNecessaria}MB</li>
                        </ul>
                    </div>
                    <div>
                        <h6>âš ï¸ Alertas Futuros</h6>
                        <ul>
                            <li>Limite de usuÃ¡rios: ${previsoes.limiteUsuarios}</li>
                            <li>Limite de armazenamento: ${previsoes.limiteArmazenamento}</li>
                            <li>Performance crÃ­tica: ${previsoes.performanceCritica}</li>
                            <li>RecomendaÃ§Ãµes: ${previsoes.recomendacoes}</li>
                        </ul>
                    </div>
                    <div>
                        <h6>ğŸ¯ OtimizaÃ§Ãµes Sugeridas</h6>
                        <ul>
                            <li>Cache: ${previsoes.otimizacaoCache}</li>
                            <li>Banco de dados: ${previsoes.otimizacaoBanco}</li>
                            <li>CDN: ${previsoes.otimizacaoCDN}</li>
                            <li>Monitoramento: ${previsoes.otimizacaoMonitoramento}</li>
                        </ul>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Erro ao gerar previsÃµes:', error);
            document.getElementById('metricasAvancadas').innerHTML = 'âŒ Erro ao gerar previsÃµes: ' + error.message;
        }
    }

    async function calcularPrevisoes() {
        const agora = new Date();
        const trintaDiasAtras = new Date(agora.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        // Calcular taxa de crescimento
        const usuariosRecentes = todosUsuarios.filter(u => {
            if (!u.criadoEm) return false;
            const data = u.criadoEm.toDate ? u.criadoEm.toDate() : new Date(u.criadoEm);
            return data >= trintaDiasAtras;
        }).length;
        
        const taxaCrescimento = todosUsuarios.length > 0 ? 
            ((usuariosRecentes / todosUsuarios.length) * 100).toFixed(1) : 0;
        
        // PrevisÃµes baseadas em crescimento
        const usuarios30dias = Math.floor(todosUsuarios.length * (1 + (taxaCrescimento / 100)));
        const usuarios90dias = Math.floor(usuarios30dias * (1 + (taxaCrescimento / 100) * 2));
        const esbocos30dias = Math.floor(todosEsbocos.length * (1 + (taxaCrescimento / 100)));
        
        // Recursos necessÃ¡rios
        const armazenamento30dias = Math.floor(todosEsbocos.length * 2 * (1 + (taxaCrescimento / 100)));
        const bandwidthEstimado = Math.floor(usuarios30dias * 50); // 50MB por usuÃ¡rio/mÃªs
        const cpuNecessario = Math.min(100, Math.floor(usuarios30dias * 0.5));
        const memoriaNecessaria = Math.floor(usuarios30dias * 10);
        
        // Alertas
        const limiteUsuarios = usuarios90dias > 1000 ? 'Considerar upgrade do plano' : 'Dentro do limite';
        const limiteArmazenamento = armazenamento30dias > 1000 ? 'Considerar limpeza de dados' : 'OK';
        const performanceCritica = cpuNecessario > 80 ? 'Monitorar performance' : 'EstÃ¡vel';
        const recomendacoes = usuarios90dias > 500 ? 'Implementar cache e CDN' : 'Sistema otimizado';
        
        // OtimizaÃ§Ãµes
        const otimizacaoCache = usuarios30dias > 100 ? 'Implementar Redis' : 'Cache atual suficiente';
        const otimizacaoBanco = todosEsbocos.length > 1000 ? 'Considerar Ã­ndices' : 'Performance OK';
        const otimizacaoCDN = bandwidthEstimado > 1000 ? 'Implementar CDN' : 'NÃ£o necessÃ¡rio';
        const otimizacaoMonitoramento = usuarios30dias > 50 ? 'Implementar APM' : 'Monitoramento bÃ¡sico';
        
        return {
            usuarios30dias,
            usuarios90dias,
            esbocos30dias,
            taxaCrescimento,
            armazenamento30dias,
            bandwidthEstimado,
            cpuNecessario,
            memoriaNecessaria,
            limiteUsuarios,
            limiteArmazenamento,
            performanceCritica,
            recomendacoes,
            otimizacaoCache,
            otimizacaoBanco,
            otimizacaoCDN,
            otimizacaoMonitoramento
        };
    }

    async function exportarAnalytics() {
        try {
            const metricas = await calcularMetricasAvancadas();
            const analise = await gerarAnaliseComportamento();
            const previsoes = await calcularPrevisoes();
            
            const analyticsCompleto = {
                data: new Date().toISOString(),
                admin: firebase.auth().currentUser.email,
                metricas,
                analise,
                previsoes,
                resumo: {
                    totalUsuarios: todosUsuarios.length,
                    totalEsbocos: todosEsbocos.length,
                    totalLogs: todosLogs.length
                }
            };
            
            // Salvar no Firestore
            await firebase.firestore().collection('analytics').add({
                ...analyticsCompleto,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Download como JSON
            const json = JSON.stringify(analyticsCompleto, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `analytics_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Analytics exportado com sucesso!');
            
        } catch (error) {
            console.error('Erro ao exportar analytics:', error);
            alert('Erro ao exportar analytics: ' + error.message);
        }
    }
    </script>
</body>
</html> 